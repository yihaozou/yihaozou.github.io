<p>author: 邹政华
comments: true
date: 2016-5-26
published: true 
tags: java
layout: post
title:  Oracle OpenJDK清理Unsafe类实现
categories: 行业 
—</p>

<p>目前java 9的开发接近尾声，预计在2017年2季度发布，大部分JEP也基本成型。其中，最关键特性或许是<a href="http://openjdk.java.net/jeps/261">JEP 261</a>（模块系统），按照<a href="http://openjdk.java.net/projects/jigsaw/spec/">JSR376</a>的说明，该特性实现了java平台的模块系统。 模块系统依赖<a href="http://openjdk.java.net/jeps/260">JEP260</a>（封装了大部分内部API），导致的结果是<a href="http://openjdk.java.net/jeps/193">JEP193</a>定义的多个句柄会暴露sun.misc.Unsafe类的功能。此前Info<a href="http://www.infoq.com/news/2015/07/oracle-plan-remove-unsafe">报道</a>过致力于解决sun.misc.Unsafe句柄问题的团队，关于可能的移植计划细节也可参见<a href="http://www.infoq.com/articles/A-Post-Apocalyptic-sun.misc.Unsafe-World">此前的报道</a>。</p>

<p><a href="https://bugs.openjdk.java.net/browse/JDK-8149159">Bug 8149159</a>最近被提交到JDK Bug管理系统, 建议优化和清理Unsafe类, 包括将参数检查从本地代码移入Java（简化JIT）、 sun.misc.Unsafe类和jdk.internal.misc.Unsafe类的统一、 以及本地代码的整体清理。</p>

<p>2月18日，Oracle工程师Mikael Vidstedt向OpenJDK开发者社区提交了两个补丁（分别针对OpenJDK和OpenJDK HotSpot VM）</p>

<p>关于这两个补丁，Vidstedt总结道：</p>

<blockquote>
  <ul>
    <li>避免代码重复，sun.misc.Unsafe将全部实现委托给jdk.internal.misc.Unsafe，这意味着java虚拟机(特别是unsafe.cpp）不再需要关心s.m.Unsafe的实现。</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>s.m.Unsafe的委派方法通常会被内联，但是为了避免性能下降的风险，仍然添加了@ForceInline注解</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>更新文档，指明用户应该确保Unsafe类的参数正确</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>参数检查从Unsage.cpp移入java，简化本地代码以及允许JIT进一步优化</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>放松了特定参数的检查，比方说最近引入的U.copySwapMemory没有检查空指针。具体原因可以参考j.i.m.U.checkPointer的文档。除了U.copySwapMemory，现有的Unsage类方法也都没有对参数执行NULL检查</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>在U.copySwapMemory类的基础上，对j.i.m.U.copyMemory增加了一个测试案例。请随时提醒我合并过来（本该如此）</li>
  </ul>
</blockquote>

<p>在Vidstedt看来，Usage类的清理算“相当激进”，需要注意的地方主要有：</p>

<blockquote>
  <ul>
    <li>Unsafe_方法以及unsafe.cpp中的其他本地方法被申明为静态方法</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>新增unsafe.hpp代码文件，文件中移入VM其他组件的一些方法。移除部分“extern”函数声明（不要过度使用extern）</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>对于不怎么用到的UNSAFE_LEAF，移除警告性质的注释（没有必要，只是个VM_LEAF）</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>一些简单的leaf方法使用UNSAFE_LEAF</li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li>UNSAFE_ENTRY/UNSAFE_END代码块新增大括号，帮助自动缩进</li>
    <li>移除未使用的Unsafe_&lt;…&gt;##140形式的函数和宏</li>
    <li>更新宏参数，与unsafe.cpp的宏定义保持一致</li>
    <li>更换带断言的参数检查，正如前面提及，这些检查移入了j.i.m.Unsafe
移除所有s.m.Unsafe相关的代码</li>
  </ul>
</blockquote>
